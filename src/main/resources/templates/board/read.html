<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>CampingDirect</title>

    <style>
        .reply-box{
            /*border: 1px solid black;*/
            /*margin-bottom: 20px;*/
            padding: 18px 25px 24px;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .box{
            border: 1px solid black;
        }

        .replyModifyingForm{
            display: none;
        }

        .read-title{
            font-size: 26px;
            color: #000;
            margin: 10px 0px;
        }


        .writer-info{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .writer-nameNDate{
            display: flex;
            flex-direction: row;
            align-items: center;

        }
        .writer-nameNDate a{
            margin-right: 13px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .readBoard-btn-box{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 34px;
            text-align: center;

        }

        .read-reply-box{
            background: #fafafa;
            display: flex;
            height: 207px;
            justify-content: center;
            align-items: center;
            margin-bottom: 28px;
        }

        .read-reply-form{
            width: 100%;
            padding: 10px 60px 10px 60px;
        }

        .reply-textarea{
            width: 100%;
            /*height: 120px;*/
            box-sizing: border-box;
            padding: 20px;
            background: #fff;
            border: 1px solid #dfdfdf;
            font-size: 14px;
        }

        .read-reply-btn{
            display: flex;
            position: static;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .reply-writer-info{
            display: flex;
            flex-direction: row;
            margin-bottom: 10px;
            height: 40px;
        }
        .reply-writer-info img{
            height: 100%;
            overflow: hidden;
            border-radius: 50%;
        }

        .reply-writer{
            margin: 0px 18px;
            font-weight: 600;
            align-self: center;
        }
        .reply-regDate{
            color: #aaa;
            align-self: center;
        }

        .reply-text{
            font-size: 14px;
            color: #3d3d3d;
            font-weight: normal;
            line-height: 1.714;
            padding: 0px 16px;
        }

        .reply-text p{
            word-break: break-all;
        }

        .container replyContainer{

        }

        .ckEditor-content{
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
        }

        .profile-img-div{
            height: 46px;
            width: 46px;
            margin-right: 15px;
        }

        .profile-img{
            height: 100%;
            overflow: hidden;
            border-radius: 50%;
        }

        .read-ragDate{
            margin-left: 20px;
        }

        .reply-box-content{
            width: 100%;

        }

        .reply-modify-div{
            display: flex;
            flex-direction: column;
        }

        .reply-modify-div button{
            width: 60px;
            margin: 5px;
        }

        .modify-textarea{
            display: none;
            width: 100%;
            height: 100px;
        }

        .firstBtn{
            border-radius: 10px;
            background-color: #c5e8ef;
            border: saddlebrown;
        }
        .secondBtn{
            display: none;
            border-radius: 10px;
            background-color: #c5e8ef;
            border: saddlebrown;
        }

        .telling-box{
            position: fixed;
            right: 80px;
            background: #fafafa;
            padding: 20px;
            border-radius: 25px;
            width: 356px;
            z-index: 999;
            top: 178px;
        }

        .telling-box div{
            display: flex;
            flex-direction: row;

        }

        .read-title{
            display: flex;
            flex-direction: row;
            justify-content: space-between;

        }

        .page-info{
            height: 100%;
            align-self: center;
        }

        .read-btn-box{
            display: flex;
            flex-direction: row;
            text-align: center;

        }

        .read-btn-box button{
            margin-left: 10px;
            height: 100%;
        }

        .modifyBtn {
            width: 4em;
        }

        .read-reply-btn a{
            height: 100%;
            text-align: center;

        }
        .read-reply-btn button{
            height: 100%;
            margin-left: 12px;
        }

        .back-to-list{
            height: 100%;
            width: 73px;

        }

        .removeBtn{
            width: 4em;

        }

        .marketDealDone{
            width: 6em;
        }

        .party-member-gear{
            display: flex;
            flex-direction: row;

        }

        .party-member-gear-img-box{
            width: 60px;
            height: 100%;
        }
        .available-gear-img {
            width: 100%;
            object-fit: cover;
        }

        .available-profile-img{
            height: 100%;
            overflow: hidden;
            border-radius: 50%;
        }

        .party-member-box{
            display: flex;
            flex-direction: row;
            border: 1px solid;
            justify-content: space-between;
        }

        .party-member-img-box{
            height: 43px;
        }

        .party-member-info{
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .party-gear-info{
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .unable-gear-img{
            width: 100%;
            /*height: 100%;*/
        }

    </style>

    <!-- 네이버 지도 API   -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hmecoefot7&submodules=geocoder"></script>

</head>

    <div class="container-lg content" layout:fragment="content">
        <div class="read-title">
          <strong th:text="${dto.title}" class="read-title"></strong>
            <button class="btn btn-info page-info">페이지 설명</button>
        </div>

        <div class="writer-info">
          <div class="writer-nameNDate">
        <!--          <a th:href="@{/member/myPage(email=${#authentication.principal.username})}" style="margin-right: 13px">-->
              <a th:href="@{#}" style="margin-right: 13px">
                  <div class="profile-img-div">
                      <img class="profile-img" th:if="${dto.profileImg != null}" th:src="${dto.profileImg}">
                      <img class="profile-img" th:unless="${dto.profileImg != null}" src="/icon/person2.svg">
                  </div>
                  <span>[[${dto.memberName}]]</span>
              </a>
              <div th:if="${dto.regDate == dto.modDate}" class="read-ragDate">
                  [[${#temporals.format(dto.regDate, 'yyyy/MM/dd')}]]
              </div>
              <div th:unless="${dto.regDate == dto.modDate}" class="read-ragDate">
                  [[${#temporals.format(dto.modDate, 'yyyy/MM/dd')}]]
              </div>
          </div>
          <div class="replyCounting">
              <label>댓글 수</label>[[${dto.replyCount}]]
          </div>
        </div>

        <!--  summernote editor content      -->
        <div class="ckEditor-content">
          <div th:utext="${dto.content}"></div>
        </div>

        <th:block th:if="${dto.category eq 'party' || tellingCategory eq 'party'}">

            <div id="map" style="width:100%;height:400px;"></div>
            <script th:inline="javascript">


                var mapOptions = {
                    center: new naver.maps.LatLng(37.3595704, 127.105399),
                    zoom: 15,
                    mapTypeControl: true
                };

                var map = new naver.maps.Map('map', mapOptions);

                var infoWindow = new naver.maps.InfoWindow({
                    anchorSkew: true
                });

                map.setCursor('pointer');


                function searchAddressToCoordinate(address) {
                    naver.maps.Service.geocode({
                        query: address
                    }, function(status, response) {
                        if (status === naver.maps.Service.Status.ERROR) {
                            return alert('Something Wrong!');
                        }

                        if (response.v2.meta.totalCount === 0) {
                            return alert('totalCount' + response.v2.meta.totalCount);
                        }

                        var htmlAddresses = [],
                            item = response.v2.addresses[0],
                            point = new naver.maps.Point(item.x, item.y);

                        if (item.roadAddress) {
                            htmlAddresses.push('[도로명 주소] ' + item.roadAddress);
                        }

                        if (item.jibunAddress) {
                            htmlAddresses.push('[지번 주소] ' + item.jibunAddress);
                        }

                        if (item.englishAddress) {
                            htmlAddresses.push('[영문명 주소] ' + item.englishAddress);
                        }

                        infoWindow.setContent([
                            '<div style="padding:10px;min-width:200px;line-height:150%;">',
                            htmlAddresses.join('<br />'),
                            '</div>'
                        ].join('\n'));

                        map.setCenter(point);
                        infoWindow.open(map, point);
                    });
                }

                var address = [[${campingLocation}]];
                console.log(address);
                function initGeocoder() {
                    searchAddressToCoordinate(address);
                }

                naver.maps.onJSContentLoaded = initGeocoder;

            </script>
        </th:block>




        <!-- 캠핑 모임       -->
        <th:block th:if="${dto.category eq 'party'}">
            <div class="join-party">
                <button class="btn btn-success join-party-btn">참가 신청</button>
            </div>

            <div class="party-gear-sort">
                <span class="sortMyGear sortAsc" data-sort="email" data-dir="asc">유저순 asc</span>
                <span class="sortMyGear sortAsc" data-sort="email" data-dir="desc">유저순 desc</span>
                <span class="sortMyGear sortAsc" data-sort="gname" data-dir="asc">이름순 asc</span>
                <span class="sortMyGear sortAsc" data-sort="gname" data-dir="desc">이름순 desc</span>
                <span class="sortMyGear sortAsc" data-sort="sort" data-dir="asc">카테고리순 asc</span>
                <span class="sortMyGear sortDesc" data-sort="sort" data-dir="desc">카테고리순 desc</span>
            </div>

            <div class="NoAvailable">

            </div>

            <div class="party-member-list">

            </div>

            <div class="col-md-12 list-pagination">
                <ul class="pagination justify-content-center align-items-center">
                    <li class="page-item">

                    </li>
                </ul>
            </div>
        </th:block>


        <form id="remove-form" th:action="@{/board/remove}" method="post">
          <input type="hidden" name="bno" th:value="${dto.bno}">
          <input type="hidden" name="email" th:value="${dto.email}">
            <input type="hidden" name="category" th:value="${pageRequestDTO.category}">
        </form>

        <div class="readBoard-btn-box">
          <a th:if="${pageRequestDTO.category != ''}" th:href="@{/board/list(page=${pageRequestDTO.page} , type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO?.category} )}">
          <button class="btn btn-outline-info">리스트</button>
          </a>
          <a th:if="${pageRequestDTO.category == ''}" th:href="@{/board/list(page=${pageRequestDTO.page} , type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword} )}">
              <button class="btn btn-outline-info back-to-list">리스트</button>
          </a>
          <th:block th:with="user=${#authentication.principal}">
              <div class="read-btn-box" th:if="${user.username != null && user.username == dto.email}">
                  <a class="read-modify-btn" th:href="@{/board/modify(bno=${dto.bno}, page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO.category} )}">
                      <button class="btn btn-outline-info modifyBtn">수정</button>
                  </a>
                  <button class="btn btn-outline-info removeBtn">삭제</button>
                  <button class="btn btn-outline-info marketDealDone" th:if="${dto.category == 'secondHands'}">거래 완료</button>
              </div>
          </th:block>
        </div>

        <div th:with="user=${#authentication.principal}" class="read-reply-box">
          <div th:action="@{/replies/}" class="read-reply-form">
              <input type="hidden" name="bno" th:value="${dto.bno}">
              <textarea name="text" class="form-control reply-textarea" placeholder="댓글을 입력하세요." id="reply-input" style="height: 101px"></textarea>
              <div class="read-reply-btn">
                <button type="submit" class="btn btn-outline-info insertReplyBtn" >등록</button>
              </div>
          </div>
        </div> <!--read-reply-box-->

        <div class="container replyContainer">

        </div>


        <!--/ introduce my project modal /-->
        <div class="modal intro-myProject" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body intro-myProject-list">
                        <div style="display: flex;">
                            <span class="material-symbols-outlined">arrow_right</span><p>로그인 유저의 authentication.pricipal.username 값과 글 작성한 유저의 ID(email) 값이 같으면 수정 삭제 권한을 얻습니다.</p>
                        </div>
                        <div style="display: flex;">
                            <span class="material-symbols-outlined">arrow_right</span><p>중고거래일 경우 게시글을 삭제하면 등록된 장비는 중고 거래 등록 및 삭제 기능이 복원됩니다.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary reading-gear-close" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="add-my-gear-hidden-box" style="display: none">

        </div>


    </div> <!--/ the end /-->




<script layout:fragment="script" th:inline="javascript">

  // const auth = [[${#authentication.principal}]]

  // const errors = [[${errors}]]
  // console.info(errors)

  $(document).ready(function (){


      var bno = [[${dto.bno}]];

      var currentUser = [[${#authentication.principal.username}]]
      console.info("currentUser: " + currentUser);

      var userEmail = [[${dto.email}]];
      console.log("userEmail: " + userEmail);

      var tellingCategory = [[${dto.category}]];
      console.log(tellingCategory);

      function formatTime(str){

          var data = new Date(str);

          return data.getFullYear() + "/" +
              (data.getMonth() +1) + "/" +
              data.getDate() + ":" +
              data.getHours() + ":" +
              data.getMinutes();

      }  // formatTime

      // 게시물 삭제 이벤트
      $(".removeBtn").on("click", function (){

          if (!confirm("삭제 하시겠습니까?")){
              console.info("confirmed");
              return;
          } // if

          $("#remove-form").submit();

      }); // removeBtn

      loadReplyList();

      // 댓글 등록 이벤트
      $(".insertReplyBtn").on("click", function (e){

          e.preventDefault();

          var replyText = $("#reply-input").val();

          var reply = {
              bno: bno,
              text: replyText,
              email: currentUser
          }

          console.info(reply);

          $.ajax({
              url:'/replies',
              type: 'POST',
              data: JSON.stringify(reply),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              success: function (result){
                  console.info(result.rno+ "번 댓글 작성 성공");
                  loadReplyList();
                  // self.location.reload();
                  $("textarea[name='text']").val("");
              }
          }); // ajax

      }); // insertReplyBtn event

      var repliesContainer = $(".replyContainer");

      // 댓글 리스트 로드 이벤트
      function loadReplyList(){

          $.getJSON('/replies/board/' + bno, function (arr){

              var str = "";

              $.each(arr, function (idx, dto){

                  console.info(arr);

                  str += ' <div class="reply-box" data-rno="'+dto.rno+'">';

                  str += '<div class="reply-box-content">';
                  str += '<div class="reply-writer-info">';
                  if (dto.profileImg != null){
                      str += '<img src="'+dto.profileImg+'">'
                  }else {
                      str += '<img src="/icon/person2.svg">'
                  }
                  str += ' <span class="reply-writer">'+dto.memberName+'</span>';
                  str += ' <span class="reply-regDate">'+formatTime(dto.regDate)+'</span>';
                  str += '</div>';
                  str += ' <div class="reply-text"><p>'+dto.text+'</p><textarea name="text" class="modify-textarea">'+dto.text+'</textarea></div>';
                  str += '</div>';
                  str += '<div class="reply-modify-div">';
                  str += '<button type="button" class="reply-modify-btn firstBtn" data-email="'+dto.email+'">수정</button>';
                  str += '<button type="button" class="replyDeleteBtn firstBtn" data-rno="'+dto.rno+'" data-email="'+dto.email+'">삭제</button>';
                  str += '<button type="button" class="doReplyModifying secondBtn" data-rno="'+dto.rno+'" data-email="'+dto.email+'">완료</button>';
                  str += '<button type="button" class="cancelReplyModifying secondBtn">취소</button></div></div>'
                  str += '</div>';

                  str += ' </div>';


              }); // each

              repliesContainer.html(str);

          }); // getJSON /replies/board

      } // loadReplyList

      // 댓글 삭제 이벤트
      $(".replyContainer").on("click", ".replyDeleteBtn", function (){

         var rno = $(this).data("rno");
         console.info("rno: " + rno);

         var writerEmail = $(this).data("email");
         console.info(writerEmail)

          if(currentUser != writerEmail){
              alert("댓글 작성자만 삭제가 가능합니다.");
              return;
          }

          if(confirm("삭제 하시겠습니까?")){
              $.ajax({
                  url: '/replies/' + rno,
                  method: 'DELETE',
                  success: function (result){
                      if (result === "success"){
                          console.info(rno + "번 댓글이 삭제되었습니다.");
                          loadReplyList();
                      }
                  }
              }); // ajax
          }
      }); // reply delete event


      // 댓글 수정 이벤트
      $(".replyContainer").on("click", ".reply-modify-btn", function (){

          var writerEmail = $(this).data("email");
          console.info("writerEmail: " + writerEmail);

          // if(principalEmail == writerEmail){
          if(currentUser != writerEmail){
              alert("댓글 작성자만 삭제가 가능합니다.");
              return;
          }

          console.info("equals");

          $(this).closest('.reply-box').find('.reply-text p, .firstBtn').css("display", "none");
          $(this).closest('.reply-box').find('.modify-textarea, .secondBtn').css("display", "block");

          $(".doReplyModifying").on('click', function (){

              var rno = $(this).data("rno");
              // var email = $(this).data("email");
              var replyModifyInput = $(this).closest('.reply-box').find('.modify-textarea').val();
              console.info("replyModifyInput: " + replyModifyInput);

              console.info("rno: " + rno);

              var reply = {
                  rno: rno,
                  bno: bno,
                  text: replyModifyInput,
                  email: currentUser
              }

              console.info(reply);

              $.ajax({
                  url: '/replies/' + rno,
                  method: 'PUT',
                  data: JSON.stringify(reply),
                  contentType: 'application/json; charset=utf-8',
                  success: function (result){
                      if(result === "success"){
                          console.info(rno + "번 댓글 수정완료");
                      }
                      loadReplyList();
                  }
              }) // ajax

          }) // doReplyModifying event

      }); // reply modifying event

      // 댓글 수정 창 닫기 이벤트
      $(".replyContainer").on("click", ".cancelReplyModifying", function (){

          $(".modify-textarea, .secondBtn").css("display", "none");
          $(".reply-text p, .firstBtn").css("display", "block");


      });  // reply canceling modify event

      // 거래 완료 버튼 클릭 (미구현)
      $(".marketDealDone").click(function (e){

          console.log("clicking");

      });

      // 프로젝트 설명 버튼 클릭
      $(".page-info").click(function (){
          $(".intro-myProject").modal('show');
      })

      //*********** 캠핑 모임 관련 **********

      var NoAvailable = $(".NoAvailable");
      var addMyGearToHidden = $(".add-my-gear-hidden-box");

      var partyList = [[${partyList}]];
      console.log(partyList);

      if(tellingCategory == "party"){

          loadMemberGears();
          function loadMemberGears(page, sort, dir){

              var bno = [[${dto.bno}]];
              var sortType = "";
              var direction = "";

              if(page == null){
                  var pageValue = 1;
              }else {
                  var pageValue = page;
              }

              if(sort != null && dir != null){
                  sortType = sort;
                  direction = dir;
              }else if (sort == null && dir == null) {
                  sortType = null;
                  direction = null;
              }

              console.log(bno);
              console.log(sortType);
              console.log(direction);
              console.log(pageValue);

              $.getJSON('/party/' + bno + "/" + sortType + "/" + direction + "/" + pageValue, function (arr){

                  console.log("---loadMemberGears---");
                  console.log(arr);

                  getMemberGearList(arr.dtoList);

                  makingPagination(arr.pageList);
              })

          }
      }

      // 참가자 리스트 정렬 버튼
      $(".party-gear-sort").on(".sortMyGear", function (){
          console.log("clicking");
      })

      $(".sortMyGear").click(function (){
          console.log("clicking");
          var sort = $(this).data("sort");
          var direction = $(this).data("dir");
          console.log(sort);
          console.log(direction);

          loadMemberGears(1, sort, direction);
      })

      // 모임 참가자 캠핑 장비 리스트 업
      function getMemberGearList(arr){

          var str = "";
          var str2 = "";
          var partyMemberListDiv = $(".party-member-list");

          console.log(arr);

          $(arr).each(function (i, dto){

              if(dto.gname != null){
                  str += '<div class="party-member-box" >';

                  str += '<div class="party-member-gear">';

                  str += '<div><b>'+i+'  '+dto.gno+'</b></div>';

                  str += '    <div class="party-member-gear-img-box">';
                  if (dto.s3Url != null){
                      str += '<img class="gear-img available-gear-img" src="'+dto.s3Url+'">';
                  }else if(dto.s3Url == null){
                      str += '<img class="gear-img unable-gear-img" src="/icon/img3.svg".svg">';
                  }
                  str += '    </div>';
                  str += '    <div class="party-gear-info">';
                  str += '        <div>'+dto.gname+'</div><div>'+dto.sort+'</div><div>'+dto.state+'</div>';
                  str += '    </div>';
                  str += '</div>';

                  str += '<div class="party-member-info">';
                  str += '    <div class="party-member-img-box">';
                  if(dto.profileImg != null){
                      str += '<img class="profile-img available-profile-img" src="'+dto.profileImg+'">';
                  }else if(dto.profileImg == null){
                      str += '<img class="profile-img unable-profile-img" src="/icon/person2.svg">';
                  }
                  str += '    </div>';
                  str += '<div>'+dto.userName+'</div>';
                  str += '<div class="party-member-gear-check">';
                  if (dto.email == currentUser){
                      str += '<input class="add-my-gear" type="checkbox" name="gno" value="'+dto.gno+'">';
                  }
                  str += '</div>';
                  str += '</div>';

                  str += '</div>';

                  str += '</div>';
              }else if (dto.gname == null){
                  str2 = '<div>등록된 장비가 아직 없습니다. <button>등록하기</button></div>';
                  NoAvailable.html(str2);
              }

          })

          partyMemberListDiv.html(str);

      }  // getMemberGearList  캠핑 모임 참가자 리스트 업

      function makingPagination(data){

          var gearPageUl = $(".pagination");

          var str = "";

          console.log(data);

          $(data).each(function (i, page){
              str += '<li class="page-link">';
              str += '<a href="'+page+'">'+page+'</a>';
              str += '</li>';
          }) // pageList each

          gearPageUl.html(str);

      } //makingPagination

      $(".list-pagination ul").on("click", "a", function (e){

          e.preventDefault();

          var page = 1;

          var targetPage = $(this).attr("href");

          page = targetPage;

          console.log(page);

          loadMemberGears(page);

      })



      // 캠핑 모임 신청 버튼 클릭
      $(".join-party-btn").click(function (){
          console.log("clicking");

          var bno = [[${dto.bno}]];
          var location = "temp-location1";

          $.getJSON('/party/' + bno + "/" + currentUser, function (count){
              console.log(count);

              if (count == '0'){

                  var data = {
                      bno: bno,
                      location: location,
                      email: currentUser
                  }

                  console.log(data);

                  $.ajax({
                      url: '/party/' + bno,
                      type: "POST",
                      data: JSON.stringify(data),
                      contentType: "application/json; charset=utf-8",
                      dataType: "text",
                      success: function (result){
                          console.log(result);
                          loadMemberGears();
                      }
                  }) // ajax
              }else if(count == '1'){
                  // alert("이미 참가했습니다.");
                  if(confirm("이미 참가했습니다. 취소하겠습니까?")){
                      console.log("참가 취소");
                      $.ajax({
                          url:'/party/' + bno + "/" + currentUser,
                          type: "DELETE",
                          success: function (result ){
                              console.log(result);
                              loadMemberGears();
                              NoAvailable.html("");
                          }
                      })

                  }
                  return false;
              } // end if
          })
      })  // 캠핑 파티 참가 버튼

      // 내 장비 등록 클릭
      $(".party-member-list").on(".add-my-gear", function (){
          console.log("clicking");

          var gno = $(this).val();
          console.log(gno);

          var str = "";

          str += '<input type="hidden" name="gno" value="'+gno+'">'

          addMyGearToHidden.append(str);
      })  // 내 장비 등록 클릭 end







  }); // the end

</script>


</html>